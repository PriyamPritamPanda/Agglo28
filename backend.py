from flask import Flask, request, jsonify
import numpy as np
import requests
from PIL import Image
import cv2
import torch
from transformers import BlipProcessor, BlipForConditionalGeneration
from huggingface_hub import InferenceClient
from flask_cors import CORS

app = Flask(_name_)
CORS(app)
# OpenWeatherMap API endpoint and key
weather_url = "https://api.openweathermap.org/data/2.5/weather"
api_key = "a67752c4dd280bdecc63a72f21110b21"

# Initialize the VLM for image analysis
device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
vlm_processor = BlipProcessor.from_pretrained("Salesforce/blip-image-captioning-base")
vlm_model = BlipForConditionalGeneration.from_pretrained("Salesforce/blip-image-captioning-base").to(device)

# Initialize InferenceClient for Hugging Face API
client = InferenceClient(api_key="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")

# Function to fetch climate data for a city
def get_weather_data(city_name):
    print(f"Fetching weather data for {city_name}...")
    params = {"q": city_name, "appid": api_key, "units": "metric"}
    response = requests.get(weather_url, params=params)
    response.raise_for_status()
    data = response.json()
    print(f"Weather data fetched for {city_name}: {data}")
    return {
        "temperature": data["main"]["temp"],
        "humidity": data["main"]["humidity"],
        "rain": data.get("rain", {}).get("1h", 0),
        "wind": data["wind"]["speed"]
    }

# Function to calculate vegetative land percentage from an image
def calculate_vegetative_land(image):
    print("Calculating vegetative land percentage...")
    image = cv2.cvtColor(np.array(image), cv2.COLOR_RGB2BGR)
    image = cv2.resize(image, (640, 480))
    hsv = cv2.cvtColor(image, cv2.COLOR_BGR2HSV)
    lower_green = np.array([35, 40, 20])
    upper_green = np.array([85, 255, 255])
    green_mask = cv2.inRange(hsv, lower_green, upper_green)
    vegetative_pixels = np.sum(green_mask > 0)
    total_pixels = image.shape[0] * image.shape[1]
    veg_percentage = (vegetative_pixels / total_pixels) * 100
    print(f"Vegetative land percentage: {veg_percentage}%")
    return veg_percentage

# Function to calculate LVR
def calculate_lvr(pre, post):
    print(f"Calculating LVR with pre: {pre}, post: {post}...")
    return post / pre if pre > 0 else 0

# Function to predict post-urbanization climate
def predict_post_urbanization_climate(pre_data, lvr):
    print(f"Predicting post-urbanization climate with LVR: {lvr}...")
    return {
        'temperature': pre_data['temperature'] * (1 + (1 - lvr) * 0.2),
        'humidity': pre_data['humidity'] * lvr,
        'rain': pre_data['rain'] * lvr,
        'wind': pre_data['wind'] * (1 + (1 - lvr) * 0.1)
    }

# Function to calculate differences
def calculate_climate_difference(pre, post):
    print("Calculating climate differences...")
    return {
        'temperature': post['temperature'] - pre['temperature'],
        'humidity': post['humidity'] - pre['humidity'],
        'rain': post['rain'] - pre['rain'],
        'wind': post['wind'] - pre['wind']
    }

# Function to calculate BRS
def calculate_brs(differences, weights):
    print("Calculating BRS...")
    return (
        weights['temp'] * np.log(1 + abs(differences['temperature'])) +
        weights['humidity'] * np.exp(-abs(differences['humidity'])) +
        weights['rain'] * np.exp(-abs(differences['rain'])) +
        weights['wind'] * abs(differences['wind'])
    )

# Function to generate suggestions
def generate_llm_suggestions(metrics, map_diff):
    print("Generating LLM suggestions...")
    prompt = f"""
    System: You are an expert in urban planning, environmental preservation, and sustainable development.
    Your task is to provide actionable recommendations for optimizing urbanization to balance ecological preservation and development needs.

    User: Based on the following data:
    Biodiversity Loss (Risk Score): {metrics['biodiversity_risk_score']}
    Temperature Increase: {metrics['temperature_increase']}Â°C
    Humidity Change: {metrics['humidity_change']}%
    Rainfall Change: {metrics['rain_change']} mm
    Wind Speed Change: {metrics['wind_speed_change']} m/s
    Vegetative Land Percentage (Pre-Urbanization): {metrics['pre_vegetative_percentage']}%
    Vegetative Land Percentage (Post-Urbanization): {metrics['post_vegetative_percentage']}%

    Additionally, here is the observed difference in pre-urbanization and post-urbanization maps:
    {map_diff}

    Using these insights, propose a detailed urban development strategy that includes:
    1. Green Space Optimization
    2. Biodiversity Corridors
    3. Development Layout Adjustments
    4. Sustainable Design Solutions
    """
    #completion = client.chat_completions.create(
        #model="meta-llama/Llama-3.2-11B-Vision-Instruct",
        #messages=[{"role": "user", "content": prompt}],
        #max_tokens=500
    #)
    #completion = client.generate(
    #model="meta-llama/Llama-3.2-11B-Vision-Instruct",
    #inputs=prompt,
    #max_tokens=500
    #)
    completion = client.chat.completions.create(
        model="meta-llama/Llama-3.2-11B-Vision-Instruct",
        messages=[
            {"role": "system", "content": "You are an expert in urban planning, environmental preservation, and sustainable development."},
            {"role": "user", "content": prompt}
        ],
        max_tokens=500
    )
    print(f"LLM suggestions generated: {completion.choices[0].message['content']}")
    return completion.choices[0].message['content']

# Flask route to handle file uploads
@app.route('/upload', methods=['POST'])
def upload():
    try:
        print("Handling upload...")
        # Get form data
        image1 = request.files['image1']
        image2 = request.files['image2']
        place_name = request.form['placeName']
        print(f"Received files: {image1.filename}, {image2.filename}, and place name: {place_name}")

        # Load images
        pre_image = Image.open(image1)
        post_image = Image.open(image2)

        # Fetch pre-urbanization climate data
        pre_climate_data = get_weather_data(place_name)

        # Calculate vegetative land percentage
        pre_vegetative_percentage = calculate_vegetative_land(pre_image)
        post_vegetative_percentage = calculate_vegetative_land(post_image)

        # Calculate LVR and predict post-urbanization climate
        lvr = calculate_lvr(pre_vegetative_percentage, post_vegetative_percentage)
        post_climate_data = predict_post_urbanization_climate(pre_climate_data, lvr)

        # Calculate climate differences and BRS
        differences = calculate_climate_difference(pre_climate_data, post_climate_data)
        weights = {'temp': 0.3, 'humidity': 0.3, 'rain': 0.2, 'wind': 0.2}
        brs = calculate_brs(differences, weights)

        # Generate suggestions
        metrics = {
            'biodiversity_risk_score': brs,
            'temperature_increase': differences['temperature'],
            'humidity_change': differences['humidity'],
            'rain_change': differences['rain'],
            'wind_speed_change': differences['wind'],
            'pre_vegetative_percentage': pre_vegetative_percentage,
            'post_vegetative_percentage': post_vegetative_percentage
        }
        map_diff = "Observed significant reduction in green spaces in the northwestern regions."
        suggestions = generate_llm_suggestions(metrics, map_diff)

        # Return JSON response
        return jsonify({
            "pre_climate_data": pre_climate_data,
            "post_climate_data": post_climate_data,
            "vegetative_percentage": {
                "pre": pre_vegetative_percentage,
                "post": post_vegetative_percentage
            },
            "lvr": lvr,
            "differences": differences,
            "biodiversity_risk_score": brs,
            "suggestions": suggestions
        })

    except Exception as e:
        print(f"Error occurred: {e}")
        return jsonify({"error": str(e)}), 500

if _name_ == '_main_':
    app.run(debug=True, host='0.0.0.0', port=5001)

~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ~
